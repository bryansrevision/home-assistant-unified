# Home Assistant Services Configuration
# YAML templates for configurable services

# Service: MQTT Broker (Mosquitto)
services:
  mqtt:
    name: 'MQTT Broker (Mosquitto)'
    enabled: true
    description: 'Central message broker for all IoT communication'

    docker_image: 'eclipse-mosquitto:latest'
    container_name: 'mosquitto'

    ports:
      - '1883:1883' # MQTT protocol
      - '8883:8883' # MQTT over SSL
      - '9001:9001' # WebSocket

    volumes:
      - './mosquitto/config:/mosquitto/config'
      - './mosquitto/data:/mosquitto/data'
      - './mosquitto/log:/mosquitto/log'

    environment:
      - 'TZ=America/New_York'

    networks:
      - 'home-automation'

    restart_policy: 'unless-stopped'

    health_check:
      test: "mosquitto_sub -n -t '$SYS/broker/uptime'"
      interval: '30s'
      timeout: '10s'
      retries: 5

    # YAML Configuration
    config_file: |
      # Default listener
      listener 1883
      protocol mqtt

      # SSL/TLS listener
      listener 8883
      protocol mqtt
      cafile /mosquitto/config/certs/ca.crt
      certfile /mosquitto/config/certs/mosquitto.crt
      keyfile /mosquitto/config/certs/mosquitto.key

      # WebSocket listener
      listener 9001
      protocol websockets

      # Allow anonymous (set to false in production)
      allow_anonymous true

      # Persistence
      persistence true
      persistence_location /mosquitto/data/

      # Security
      password_file /mosquitto/config/passwd.txt
      acl_file /mosquitto/config/acl.txt

      # Max connections
      max_connections -1
      max_queued_messages 1000
      message_size_limit 0

      # Performance
      max_inflight_messages 20

      # Logging
      log_dest file /mosquitto/log/mosquitto.log
      log_dest stdout
      log_type all

  # Service: InfluxDB Time-Series Database
  influxdb:
    name: 'InfluxDB Time-Series Database'
    enabled: true
    description: 'Time-series database for metrics storage'

    docker_image: 'influxdb:2.7'
    container_name: 'influxdb'

    ports:
      - '8086:8086'

    volumes:
      - 'influxdb_data:/var/lib/influxdb2'
      - 'influxdb_config:/etc/influxdb2'

    environment:
      - 'INFLUXDB_DB=${INFLUXDB_DB:-omi_metrics}'
      - 'INFLUXDB_ADMIN_USER=${INFLUXDB_ADMIN_USER:-admin}'
      - 'INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASSWORD:-changeme}'
      - 'INFLUXDB_INITIAL_RETENTION_BUCKET_RETENTION_IS_INFINITE=true'
      - 'INFLUXDB_HTTP_AUTH_ENABLED=true'

    networks:
      - 'home-automation'

    restart_policy: 'unless-stopped'

    health_check:
      test: 'curl -s http://localhost:8086/health'
      interval: '30s'
      timeout: '10s'
      retries: 5

    # Resources
    resources:
      limits:
        cpus: '2.0'
        memory: '1G'
      reservations:
        cpus: '1.0'
        memory: '512M'

  # Service: Grafana Dashboard
  grafana:
    name: 'Grafana Monitoring Dashboards'
    enabled: true
    description: 'Visualization and monitoring dashboards'

    docker_image: 'grafana/grafana:latest'
    container_name: 'grafana'

    ports:
      - '3000:3000'

    volumes:
      - 'grafana_data:/var/lib/grafana'
      - './grafana/provisioning:/etc/grafana/provisioning'

    environment:
      - 'GF_SECURITY_ADMIN_USER=admin'
      - 'GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}'
      - 'GF_INSTALL_PLUGINS=grafana-piechart-panel'
      - 'GF_USERS_ALLOW_SIGN_UP=false'

    networks:
      - 'home-automation'

    restart_policy: 'unless-stopped'

    health_check:
      test: 'curl -s http://localhost:3000/api/health'
      interval: '30s'
      timeout: '10s'
      retries: 5

    # Provisioning
    provisioning:
      dashboards:
        - name: 'Omi Wearables Overview'
          file: 'grafana/dashboards/omi-overview.json'

        - name: 'Home Assistant Status'
          file: 'grafana/dashboards/ha-status.json'

        - name: 'Proxmox Infrastructure'
          file: 'grafana/dashboards/proxmox-infra.json'

      datasources:
        - name: 'InfluxDB Metrics'
          type: 'influxdb'
          url: 'http://influxdb:8086'
          database: '${INFLUXDB_DB}'
          auth_required: true

        - name: 'Prometheus'
          type: 'prometheus'
          url: 'http://prometheus:9090'

  # Service: Bee AI AgentStack
  agentstack:
    name: 'Bee AI AgentStack'
    enabled: true
    description: 'AI agent orchestration and memory processing'

    docker_image: 'agentstack/agentstack:latest'
    container_name: 'agentstack'

    ports:
      - '3100:3100' # UI
      - '8001:8001' # API

    volumes:
      - './agentstack/config:/app/config'
      - './agentstack/agents:/app/agents'
      - './agentstack/data:/app/data'

    environment:
      - 'AGENTSTACK_CONFIG=/app/config/beeai_agentstack.yaml'
      - 'OPENAI_API_KEY=${OPENAI_API_KEY}'
      - 'ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}'
      - 'AGENTSTACK_AUTO_PROCESS=true'
      - 'AGENTSTACK_BATCH_SIZE=10'
      - 'AGENTSTACK_INTERVAL_SECONDS=60'

    networks:
      - 'home-automation'

    depends_on:
      - 'mqtt'
      - 'influxdb'

    restart_policy: 'unless-stopped'

    health_check:
      test: 'curl -s http://localhost:8001/health'
      interval: '30s'
      timeout: '10s'
      retries: 5

    # Agent Configuration
    agents:
      - name: 'memory_analyzer'
        model: 'gpt-4'
        capabilities: ['analysis', 'summarization']

      - name: 'health_monitor'
        model: 'gpt-4'
        capabilities: ['health_tracking', 'wellness']

      - name: 'task_manager'
        model: 'gpt-4'
        capabilities: ['task_extraction', 'prioritization']

  # Service: Home Assistant Core
  home_assistant:
    name: 'Home Assistant Core'
    enabled: true
    description: 'Home automation platform'

    docker_image: 'ghcr.io/home-assistant/home-assistant:latest'
    container_name: 'homeassistant'

    ports:
      - '8123:8123'

    volumes:
      - './home-assistant:/config'
      - '/run/dbus:/run/dbus:ro'

    environment:
      - 'TZ=America/New_York'

    networks:
      - 'home-automation'

    depends_on:
      - 'mqtt'
      - 'influxdb'

    restart_policy: 'unless-stopped'

    network_mode: 'host' # Recommended for Home Assistant

    # Home Assistant Configuration
    integrations:
      - name: 'mqtt'
        enabled: true
        config:
          broker: 'mosquitto'
          port: 1883

      - name: 'influxdb'
        enabled: true
        config:
          host: 'influxdb'
          port: 8086
          database: '${INFLUXDB_DB}'

      - name: 'rest'
        enabled: true

  # Service: Webhook Service for Omi
  webhook_service:
    name: 'Webhook Service for Omi Integration'
    enabled: true
    description: 'FastAPI service for webhook processing'

    docker_image: 'bryansrevision/omi-webhook-service:latest'
    container_name: 'omi-webhook'

    ports:
      - '8000:8000' # API
      - '8001:8001' # Webhook endpoint

    volumes:
      - './webhook/config:/app/config'
      - './webhook/logs:/app/logs'

    environment:
      - 'OMI_WEBHOOK_SECRET=${OMI_WEBHOOK_SECRET}'
      - 'OMI_MCP_API_TOKEN=${OMI_MCP_API_TOKEN}'
      - 'OMI_MCP_BASE_URL=${OMI_MCP_BASE_URL:-https://api.omi.me}'
      - 'MQTT_BROKER=mosquitto'
      - 'MQTT_PORT=1883'
      - 'INFLUXDB_HOST=influxdb'
      - 'INFLUXDB_PORT=8086'
      - 'INFLUXDB_DB=${INFLUXDB_DB}'
      - 'LOG_LEVEL=INFO'

    networks:
      - 'home-automation'

    depends_on:
      - 'mqtt'
      - 'influxdb'

    restart_policy: 'unless-stopped'

    health_check:
      test: 'curl -s http://localhost:8000/health'
      interval: '30s'
      timeout: '10s'
      retries: 5

  # Service: Node-RED
  node_red:
    name: 'Node-RED Visual Programming'
    enabled: false
    description: 'Visual programming for automations'

    docker_image: 'nodered/node-red:latest'
    container_name: 'node-red'

    ports:
      - '1880:1880'

    volumes:
      - 'node_red_data:/data'

    environment:
      - 'TZ=America/New_York'
      - 'NODE_RED_ENABLE_PROJECTS=true'

    networks:
      - 'home-automation'

    depends_on:
      - 'mqtt'

    restart_policy: 'unless-stopped'

# Network Definition
networks:
  home-automation:
    driver: 'bridge'

# Volumes
volumes:
  influxdb_data:
  influxdb_config:
  grafana_data:
  node_red_data:

# Service Dependencies and Boot Order
startup_order:
  1: 'mqtt'
  2: 'influxdb'
  3: 'grafana'
  4: 'webhook_service'
  5: 'agentstack'
  6: 'home_assistant'

# Health Monitoring
health_monitoring:
  enabled: true
  check_interval_seconds: 60

  checks:
    - service: 'mqtt'
      endpoint: 'mqtt://mosquitto:1883'
      type: 'connection'

    - service: 'influxdb'
      endpoint: 'http://influxdb:8086/health'
      type: 'http'

    - service: 'grafana'
      endpoint: 'http://grafana:3000/api/health'
      type: 'http'

    - service: 'home_assistant'
      endpoint: 'http://homeassistant:8123/api/'
      type: 'http'

    - service: 'webhook_service'
      endpoint: 'http://omi-webhook:8000/health'
      type: 'http'

    - service: 'agentstack'
      endpoint: 'http://agentstack:8001/health'
      type: 'http'

# Backup Configuration
backup:
  enabled: true
  schedule: '0 2 * * *' # Daily at 2 AM
  retention_days: 30
  targets:
    - 'home_assistant_config'
    - 'mqtt_data'
    - 'grafana_dashboards'

# Resource Limits
resource_limits:
  default:
    cpus: '1.0'
    memory: '512M'

  services:
    influxdb:
      cpus: '2.0'
      memory: '1G'

    grafana:
      cpus: '1.0'
      memory: '512M'

    home_assistant:
      cpus: '2.0'
      memory: '1G'
