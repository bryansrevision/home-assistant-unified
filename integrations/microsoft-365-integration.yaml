# ============================================================================
# MICROSOFT 365 / GRAPH INTEGRATION
# Mail, To Do, Calendar, OneDrive actions via Microsoft Graph
# ============================================================================

input_text:
  graph_access_token:
    name: "Microsoft Graph Access Token"
    initial: ""
    max: 4096

  graph_mail_to:
    name: "Graph Mail To"
    initial: "user@example.com"
    max: 255

  graph_mail_subject:
    name: "Graph Mail Subject"
    initial: "Home Assistant Notification"
    max: 255

  graph_mail_body:
    name: "Graph Mail Body"
    initial: "Hello from Home Assistant"
    max: 1024

  graph_todo_list_id:
    name: "Graph ToDo List ID"
    initial: ""
    max: 255

  graph_task_title:
    name: "Graph Task Title"
    initial: "Home Assistant Task"
    max: 255

  graph_onedrive_path:
    name: "OneDrive Upload Path"
    initial: "/HomeAssistant/notes.txt"
    max: 255

  graph_file_content:
    name: "OneDrive File Content"
    initial: "Hello from Home Assistant"
    max: 4096

rest_command:
  graph_send_mail:
    url: "https://graph.microsoft.com/v1.0/me/sendMail"
    method: POST
    headers:
      Authorization: "Bearer {{ states('input_text.graph_access_token') }}"
      Content-Type: "application/json"
    payload: >
      {
        "message": {
          "subject": "{{ states('input_text.graph_mail_subject') }}",
          "body": {
            "contentType": "Text",
            "content": "{{ states('input_text.graph_mail_body') }}"
          },
          "toRecipients": [
            {
              "emailAddress": {
                "address": "{{ states('input_text.graph_mail_to') }}"
              }
            }
          ]
        }
      }
    content_type: "application/json"
    timeout: 30

  graph_create_todo_task:
    url: "https://graph.microsoft.com/v1.0/me/todo/lists/{{ states('input_text.graph_todo_list_id') }}/tasks"
    method: POST
    headers:
      Authorization: "Bearer {{ states('input_text.graph_access_token') }}"
      Content-Type: "application/json"
    payload: >
      {
        "title": "{{ states('input_text.graph_task_title') }}"
      }
    content_type: "application/json"
    timeout: 30

  graph_create_event:
    url: "https://graph.microsoft.com/v1.0/me/events"
    method: POST
    headers:
      Authorization: "Bearer {{ states('input_text.graph_access_token') }}"
      Content-Type: "application/json"
    payload: >
      {
        "subject": "Home Assistant Event",
        "start": {
          "dateTime": "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}",
          "timeZone": "America/New_York"
        },
        "end": {
          "dateTime": "{{ (now() + timedelta(hours=1)).strftime('%Y-%m-%dT%H:%M:%S') }}",
          "timeZone": "America/New_York"
        }
      }
    content_type: "application/json"
    timeout: 30

  graph_onedrive_upload:
    url: "https://graph.microsoft.com/v1.0/me/drive/root:{{ states('input_text.graph_onedrive_path') }}:/content"
    method: PUT
    headers:
      Authorization: "Bearer {{ states('input_text.graph_access_token') }}"
      Content-Type: "text/plain"
    payload: "{{ states('input_text.graph_file_content') }}"
    content_type: "text/plain"
    timeout: 60

script:
  graph_send_quick_mail:
    alias: "Graph - Send Quick Mail"
    description: "Send email with current input_text values"
    sequence:
      - service: rest_command.graph_send_mail

  graph_create_quick_task:
    alias: "Graph - Create Quick Task"
    description: "Create Microsoft To Do task from input_text"
    sequence:
      - service: rest_command.graph_create_todo_task

  graph_create_quick_event:
    alias: "Graph - Create Quick Event"
    description: "Create calendar event with default 1-hour duration"
    sequence:
      - service: rest_command.graph_create_event

  graph_upload_quick_note:
    alias: "Graph - Upload Quick Note"
    description: "Upload OneDrive file from input_text"
    sequence:
      - service: rest_command.graph_onedrive_upload

# NOTE:
# - Provide a valid Microsoft Graph access token in input_text.graph_access_token
# - Token scopes needed: Mail.Send, Tasks.ReadWrite, Calendars.ReadWrite, Files.ReadWrite
